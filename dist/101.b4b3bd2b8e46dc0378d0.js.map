{"version":3,"file":"101.b4b3bd2b8e46dc0378d0.js","mappings":"0NAMO,MAAMA,UAA+C,EAAAC,wBAMxDC,YAAYC,GACRC,MAAMD,GAAO,GAEbE,KAAKC,gBAAiB,EACtBD,KAAKE,UAAW,EAChBF,KAAKG,SAAW,KAChBH,KAAKI,KAAO,KAGNC,a,UACN,MAAMC,EAC4B,QAA9B,EAAyB,QAAzB,EAAAN,KAAKO,OAAOC,qBAAa,eAAG,UAAE,QAAIR,KAAKO,OAAOE,aAE9CH,IACCA,EAAmCI,MAAQ,MAAQC,KAAKC,GAAK,EAC7DN,EAAmCO,KAAO,IAC1CP,EAAmCQ,OAAS,MAC5CR,EAAmCS,qBACnCT,EAAmCU,UAChC,IAAI,UAAgB,EAAG,EAAG,IAE7BV,EAAmCO,KAAO,IAC1CP,EAAmCS,4BAGlC,0BACF,4CACA,eACAf,KAAKO,QAGoC,QAA7C,EAAAP,KAAKO,OAAOU,gBAAgB,yBAAiB,SAAEC,UAE3ClB,KAAKO,OAAOC,eAAiBR,KAAKO,OAAOC,cAAcW,OAAS,EAChEnB,KAAKO,OAAOC,cAAc,GAAKF,EAE/BN,KAAKO,OAAOE,aAAeH,EAG/BN,KAAKI,KAAO,IAAI,oBAA0B,MAAO,EAAGJ,KAAKO,QAEzDP,KAAKO,OACAa,cAAc,OACdC,iBACAC,SAASC,IACNA,EAAEC,YAAW,GACbD,EAAEE,QAAQC,OAAO,IACjBH,EAAEI,SAASC,EAAIjB,KAAKC,GAAK,EAGxBW,EAAEM,SAAiBC,iBAAkB,EACrCP,EAAEM,SAAiBE,gBAChBR,EAAEM,SACJG,eACFhC,KAAKI,KAAM6B,iBACPV,EACA,IACA,mBACA,MAQZvB,KAAKG,eAAiBH,KAAKI,KAAK8B,iBAEhClC,KAAKG,SAASqB,YAAW,GAEzB,MAAMW,EAA0BnC,KAAKI,KAAK+B,UACpCC,EAAgBD,EAAUE,MAAM,GAChCC,EAAeH,EAAUhB,OAAS,EAExCnB,KAAKuC,mBAAmBC,OAAOC,cAAwB,SACnD,IAAI,eACAzC,KAAK0C,QACLP,EACA,6BACA,GACA,EACA,GACA,GAERnC,KAAKuC,mBAAmBC,OAAOC,cAAqB,MAChD,IAAI,eACAzC,KAAK0C,QACL1C,KAAKI,KAAKuC,OACV,SACA,GACA,EACA,GACA,GAIJ3C,KAAKuC,mBAAmBC,OAC1BI,gBAAgBN,GAElBtC,KAAKuC,mBAAmBC,OAAOK,aAAe,IAC9C7C,KAAKuC,mBAAmBC,OAAOM,uBAAyB,GACxD9C,KAAKuC,mBAAmBQ,eAAeC,iBAAmB,EAC1DhD,KAAKuC,mBAAmBQ,eAAeE,oBAAsB,GAC7DjD,KAAKuC,mBAAmBQ,eAAeG,uBAAyB,EAChElD,KAAKuC,mBAAmBQ,eAAeI,oBAAsB,GAC7DnD,KAAKuC,mBAAmBQ,eAAeK,iBAAmB,KAC1DpD,KAAKuC,mBAAmBQ,eAAeM,QAAU,IACjDrD,KAAKuC,mBAAmBQ,eAAeO,wBAAyB,EAChEtD,KAAKuC,mBAAmBQ,eAAeQ,aAAe,GAEtD,MAAMC,EAAqB,GACrBC,EAAkB,GAClBC,EAAoB,GAEpBC,EAAgB,KAClB,MAAMC,EAAM,IAAI,UAAgB,KAAM,KAAM,MACxCC,EAAM,IAAI,WAAiB,MAAO,MAAO,MAC7C,IAAK,IAAIC,EAAI,EAAGA,EAAIxB,IAAgBwB,EAChCF,EAAIG,EAAIpD,KAAKiD,IAAIzB,EAAc,EAAJ2B,EAAQ,GAAIF,EAAIG,GAC3CH,EAAIhC,EAAIjB,KAAKiD,IAAIzB,EAAc,EAAJ2B,EAAQ,GAAIF,EAAIhC,GAC3CgC,EAAII,EAAIrD,KAAKiD,IAAIzB,EAAc,EAAJ2B,EAAQ,GAAIF,EAAII,GAC3CH,EAAIE,EAAIpD,KAAKkD,IAAI1B,EAAc,EAAJ2B,EAAQ,GAAID,EAAIE,GAC3CF,EAAIjC,EAAIjB,KAAKkD,IAAI1B,EAAc,EAAJ2B,EAAQ,GAAID,EAAIjC,GAC3CiC,EAAIG,EAAIrD,KAAKkD,IAAI1B,EAAc,EAAJ2B,EAAQ,GAAID,EAAIG,GAG/CR,EAASrC,OAAS,EAClBsC,EAAMtC,OAAS,EACfuC,EAAQvC,OAAS,EAEjB,IAAK,IAAI2C,EAAI,EAAGA,EAAIxB,IAAgBwB,EAAG,CACnC,MAAMG,EAAoB,KAAhBtD,KAAKuD,SACTC,EAAoB,KAAhBxD,KAAKuD,SACTE,EAAoB,KAAhBzD,KAAKuD,SAEfT,EAAMY,OAAO,GAAM1D,KAAKuD,UAAYvD,KAAKuD,SAAWD,GACpDR,EAAMY,KAAK1D,KAAKuD,UAAYvD,KAAKuD,SAAW,GAAOC,GACnDV,EAAMY,OAAO,GAAM1D,KAAKuD,UAAYvD,KAAKuD,SAAWE,GAEpDZ,EAASa,KAAK,EAAG,EAAG,GAEpBX,EAAQW,KAAK,GAGjBrE,KAAKC,gBAAiB,GAI1BD,KAAKsE,eAAiBtE,KAAKO,OAAOgE,yBAAyBC,KAAI,KAC3D,GAAKxE,KAAKE,WAINF,KAAKC,iBACLkC,EAAUsC,IAAIrC,GACduB,IACA3D,KAAKuC,mBAAmBC,OAAOC,cACjB,SACZiC,eAAevC,EAAW,KAG5BnC,KAAK2E,SAAT,CAKA,IAAK,IAAIb,EAAI,EAAGA,EAAIxB,IAAgBwB,GAC5BJ,EAAQI,KAIZL,EAAU,EAAJK,EAAQ,KAAM,sBACpBN,EAAa,EAAJM,EAAQ,IAAML,EAAU,EAAJK,EAAQ,GACrCN,EAAa,EAAJM,EAAQ,IAAML,EAAU,EAAJK,EAAQ,GACrCN,EAAa,EAAJM,EAAQ,IAAML,EAAU,EAAJK,EAAQ,GACrC3B,EAAc,EAAJ2B,EAAQ,IAAMN,EAAa,EAAJM,EAAQ,GACzC3B,EAAc,EAAJ2B,EAAQ,IAAMN,EAAa,EAAJM,EAAQ,GACzC3B,EAAc,EAAJ2B,EAAQ,IAAMN,EAAa,EAAJM,EAAQ,GACrC3B,EAAc,EAAJ2B,EAAQ,KAAO,IAEzBN,EAAa,EAAJM,EAAQ,MAAQnD,KAAKuD,SAAW,GAAK,IAE1C/B,EAAc,EAAJ2B,EAAQ,GAAKN,EAAa,EAAJM,EAAQ,IAAM,IAC9CJ,EAAQI,GAAK,GAEjB3B,EAAc,EAAJ2B,EAAQ,IAAM,IAIhC9D,KAAKE,SAELF,KAAKuC,mBAAmBC,OAAOC,cACjB,SACZiC,eAAevC,EAAW,OAGhCpC,MAAM6E,OAGH1D,U,MACHnB,MAAMmB,UAENlB,KAAKO,OAAOa,cAAc,OAAQF,SAAQ,GAAO,GAKxC,QAAT,EAAAlB,KAAKI,YAAI,SAAEc,UAGL2D,mBACN,MAAMC,EAAS,CACXC,OAAQ/E,KAAK2E,QACbK,MAAO,KACHhF,KAAKC,gBAAiB,EACtBD,KAAKE,UAAW,IAIlB+E,EAAWjF,KAAKkF,KAEtBD,EAAST,IAAIM,EAAQ,SAASK,KAAK,SAEnCF,EACKT,IAAIM,EAAQ,UACZK,KAAK,SACLC,UAAUC,IACPrF,KAAK2E,QAAUU","sources":["webpack://babylonjs-fluid-rendering/./src/scenes/fluidSimulationDemoParticleCustomShape.ts"],"sourcesContent":["import * as BABYLON from \"@babylonjs/core\";\r\n//import * as BABYLONSER from \"@babylonjs/serializers\";\r\n\r\nimport { FluidSimulationDemoBase } from \"./fluidSimulationDemoBase\";\r\nimport { FluidRenderingObjectVertexBuffer } from \"./FluidRenderer/fluidRenderingObjectVertexBuffer\";\r\n\r\nexport class FluidSimulationDemoParticleCustomShape extends FluidSimulationDemoBase {\r\n    private _initParticles: boolean;\r\n    private _started: boolean;\r\n    private _meshPCS: BABYLON.Nullable<BABYLON.Mesh>;\r\n    private _pcs: BABYLON.Nullable<BABYLON.PointsCloudSystem>;\r\n\r\n    constructor(scene: BABYLON.Scene) {\r\n        super(scene, true);\r\n\r\n        this._initParticles = true;\r\n        this._started = false;\r\n        this._meshPCS = null;\r\n        this._pcs = null;\r\n    }\r\n\r\n    protected async _run() {\r\n        const camera =\r\n            this._scene.activeCameras?.[0] ?? this._scene.activeCamera;\r\n\r\n        if (camera) {\r\n            (camera as BABYLON.ArcRotateCamera).alpha = 1.593 - Math.PI / 8;\r\n            (camera as BABYLON.ArcRotateCamera).beta = 1.3;\r\n            (camera as BABYLON.ArcRotateCamera).radius = 9.633;\r\n            (camera as BABYLON.ArcRotateCamera).computeWorldMatrix();\r\n            (camera as BABYLON.ArcRotateCamera).setTarget(\r\n                new BABYLON.Vector3(0, 3, 0)\r\n            );\r\n            (camera as BABYLON.ArcRotateCamera).beta = 1.3;\r\n            (camera as BABYLON.ArcRotateCamera).computeWorldMatrix();\r\n        }\r\n\r\n        await BABYLON.SceneLoader.AppendAsync(\r\n            \"https://assets.babylonjs.com/meshes/Dude/\",\r\n            \"dude.babylon\",\r\n            this._scene\r\n        );\r\n\r\n        this._scene.getCameraByName(\"Default camera\")?.dispose();\r\n\r\n        if (this._scene.activeCameras && this._scene.activeCameras.length > 0) {\r\n            this._scene.activeCameras[0] = camera!;\r\n        } else {\r\n            this._scene.activeCamera = camera;\r\n        }\r\n\r\n        this._pcs = new BABYLON.PointsCloudSystem(\"pcs\", 3, this._scene);\r\n\r\n        this._scene\r\n            .getMeshByName(\"him\")!\r\n            .getChildMeshes()\r\n            .forEach((m) => {\r\n                m.setEnabled(false);\r\n                m.scaling.setAll(0.1);\r\n                m.rotation.y = Math.PI / 8;\r\n                //m.rotation.y = Math.PI;\r\n                //(m as BABYLON.Mesh).bakeCurrentTransformIntoVertices();\r\n                (m.material as any).disableLighting = true;\r\n                (m.material as any).emissiveTexture = (\r\n                    m.material as any\r\n                ).diffuseTexture;\r\n                this._pcs!.addSurfacePoints(\r\n                    m as BABYLON.Mesh,\r\n                    5000,\r\n                    BABYLON.PointColor.Color,\r\n                    0\r\n                );\r\n            });\r\n\r\n        /*this._scene.useRightHandedSystem = true;\r\n        console.log(BABYLONSER.OBJExport.OBJ(this._scene.getMeshByName(\"him\")!.getChildMeshes()));\r\n        this._scene.useRightHandedSystem = false;*/\r\n\r\n        this._meshPCS = await this._pcs.buildMeshAsync();\r\n\r\n        this._meshPCS.setEnabled(false);\r\n\r\n        const positions: Float32Array = this._pcs.positions;\r\n        const origPositions = positions.slice(0);\r\n        const numParticles = positions.length / 3;\r\n\r\n        this._fluidRenderObject.object.vertexBuffers[\"position\"] =\r\n            new BABYLON.VertexBuffer(\r\n                this._engine,\r\n                positions,\r\n                BABYLON.VertexBuffer.PositionKind,\r\n                true,\r\n                false,\r\n                3,\r\n                true\r\n            );\r\n        this._fluidRenderObject.object.vertexBuffers[\"color\"] =\r\n            new BABYLON.VertexBuffer(\r\n                this._engine,\r\n                this._pcs.colors,\r\n                \"color\",\r\n                false,\r\n                false,\r\n                4,\r\n                true\r\n            );\r\n\r\n        (\r\n            this._fluidRenderObject.object as FluidRenderingObjectVertexBuffer\r\n        ).setNumParticles(numParticles);\r\n\r\n        this._fluidRenderObject.object.particleSize = 0.15;\r\n        this._fluidRenderObject.object.particleThicknessAlpha = 0.1;\r\n        this._fluidRenderObject.targetRenderer.minimumThickness = 0;\r\n        this._fluidRenderObject.targetRenderer.blurDepthFilterSize = 15;\r\n        this._fluidRenderObject.targetRenderer.blurDepthNumIterations = 8;\r\n        this._fluidRenderObject.targetRenderer.blurDepthDepthScale = 50;\r\n        this._fluidRenderObject.targetRenderer.thicknessMapSize = 1024;\r\n        this._fluidRenderObject.targetRenderer.density = 0.63;\r\n        this._fluidRenderObject.targetRenderer.generateDiffuseTexture = true;\r\n        this._fluidRenderObject.targetRenderer.fresnelClamp = 0.1;\r\n\r\n        const velocity: number[] = [];\r\n        const accel: number[] = [];\r\n        const stopped: number[] = [];\r\n\r\n        const initParticles = () => {\r\n            const min = new BABYLON.Vector3(1e10, 1e10, 1e10),\r\n                max = new BABYLON.Vector3(-1e10, -1e10, -1e10);\r\n            for (let i = 0; i < numParticles; ++i) {\r\n                min.x = Math.min(positions[i * 3 + 0], min.x);\r\n                min.y = Math.min(positions[i * 3 + 1], min.y);\r\n                min.z = Math.min(positions[i * 3 + 2], min.z);\r\n                max.x = Math.max(positions[i * 3 + 0], max.x);\r\n                max.y = Math.max(positions[i * 3 + 1], max.y);\r\n                max.z = Math.max(positions[i * 3 + 2], max.z);\r\n            }\r\n\r\n            velocity.length = 0;\r\n            accel.length = 0;\r\n            stopped.length = 0;\r\n\r\n            for (let i = 0; i < numParticles; ++i) {\r\n                const f = Math.random() * 0.005;\r\n                const g = Math.random() * 0.001;\r\n                const h = Math.random() * 0.005;\r\n\r\n                accel.push((-0.5 + Math.random()) * Math.random() * f);\r\n                accel.push(Math.random() * (Math.random() + 1.0) * g);\r\n                accel.push((-0.5 + Math.random()) * Math.random() * h);\r\n\r\n                velocity.push(0, 0, 0);\r\n\r\n                stopped.push(0);\r\n            }\r\n\r\n            this._initParticles = false;\r\n        };\r\n\r\n        const dt = 1 / 60 / 1000;\r\n        this._sceneObserver = this._scene.onBeforeRenderObservable.add(() => {\r\n            if (!this._started) {\r\n                return;\r\n            }\r\n\r\n            if (this._initParticles) {\r\n                positions.set(origPositions);\r\n                initParticles();\r\n                this._fluidRenderObject.object.vertexBuffers[\r\n                    \"position\"\r\n                ].updateDirectly(positions, 0);\r\n            }\r\n\r\n            if (this._paused) {\r\n                return;\r\n            }\r\n\r\n            let numStopped = 0;\r\n            for (let i = 0; i < numParticles; ++i) {\r\n                if (stopped[i]) {\r\n                    numStopped++;\r\n                    continue;\r\n                }\r\n                accel[i * 3 + 1] += -9.81 * dt;\r\n                velocity[i * 3 + 0] += accel[i * 3 + 0];\r\n                velocity[i * 3 + 1] += accel[i * 3 + 1];\r\n                velocity[i * 3 + 2] += accel[i * 3 + 2];\r\n                positions[i * 3 + 0] += velocity[i * 3 + 0];\r\n                positions[i * 3 + 1] += velocity[i * 3 + 1];\r\n                positions[i * 3 + 2] += velocity[i * 3 + 2];\r\n                if (positions[i * 3 + 1] <= -2) {\r\n                    //velocity[i * 3 + 0] *= Math.random() / 10 + 0.8;\r\n                    velocity[i * 3 + 1] *= -(Math.random() / 10 + 0.4);\r\n                    //velocity[i * 3 + 2] *= Math.random() / 10 + 0.8;\r\n                    if (positions[i * 3 + 1] + velocity[i * 3 + 1] < -2) {\r\n                        stopped[i] = 1;\r\n                    }\r\n                    positions[i * 3 + 1] = -2;\r\n                }\r\n            }\r\n\r\n            this._started == numStopped < numParticles;\r\n\r\n            this._fluidRenderObject.object.vertexBuffers[\r\n                \"position\"\r\n            ].updateDirectly(positions, 0);\r\n        });\r\n\r\n        super._run();\r\n    }\r\n\r\n    public dispose() {\r\n        super.dispose();\r\n\r\n        this._scene.getMeshByName(\"him\")!.dispose(false, true);\r\n        /*this._scene.getMeshByName(\"him\")!.getChildMeshes().forEach((m) => {\r\n            m.dispose();\r\n        });*/\r\n\r\n        this._pcs?.dispose();\r\n    }\r\n\r\n    protected _makeGUIMainMenu(): void {\r\n        const params = {\r\n            paused: this._paused,\r\n            start: () => {\r\n                this._initParticles = true;\r\n                this._started = true;\r\n            },\r\n        };\r\n\r\n        const mainMenu = this._gui!;\r\n\r\n        mainMenu.add(params, \"start\").name(\"Start\");\r\n\r\n        mainMenu\r\n            .add(params, \"paused\")\r\n            .name(\"Pause\")\r\n            .onChange((value: boolean) => {\r\n                this._paused = value;\r\n            });\r\n    }\r\n}\r\n"],"names":["FluidSimulationDemoParticleCustomShape","FluidSimulationDemoBase","constructor","scene","super","this","_initParticles","_started","_meshPCS","_pcs","async","camera","_scene","activeCameras","activeCamera","alpha","Math","PI","beta","radius","computeWorldMatrix","setTarget","getCameraByName","dispose","length","getMeshByName","getChildMeshes","forEach","m","setEnabled","scaling","setAll","rotation","y","material","disableLighting","emissiveTexture","diffuseTexture","addSurfacePoints","buildMeshAsync","positions","origPositions","slice","numParticles","_fluidRenderObject","object","vertexBuffers","_engine","colors","setNumParticles","particleSize","particleThicknessAlpha","targetRenderer","minimumThickness","blurDepthFilterSize","blurDepthNumIterations","blurDepthDepthScale","thicknessMapSize","density","generateDiffuseTexture","fresnelClamp","velocity","accel","stopped","initParticles","min","max","i","x","z","f","random","g","h","push","_sceneObserver","onBeforeRenderObservable","add","set","updateDirectly","_paused","_run","_makeGUIMainMenu","params","paused","start","mainMenu","_gui","name","onChange","value"],"sourceRoot":""}