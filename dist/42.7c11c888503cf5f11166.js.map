{"version":3,"file":"42.7c11c888503cf5f11166.js","mappings":"qMAcO,MAAMA,EA+FTC,YAAYC,EAA0BC,EAA2BC,EAAO,GAnF9D,KAAAC,iBAAmB,GAWtB,KAAAC,iBAAmB,IAEnB,KAAAC,iBAAmB,GAEnB,KAAAC,UAAY,KAEZ,KAAAC,QAAU,IAAI,UAAgB,GAAI,IAAK,GAEvC,KAAAC,YAAc,IAEd,KAAAC,YAAc,GAEd,KAAAC,gBAAkB,IA6DrBC,KAAKC,gBAAaC,EAClBF,KAAKG,iBAAcD,EACnBF,KAAKI,WAAa,GAClBJ,KAAKK,iBAAmB,EACxBL,KAAKM,MAAQf,EAETF,GAAaC,GACbU,KAAKO,gBAAgBlB,EAAWC,GAGpCU,KAAKQ,MAAQ,IAAI,EAAAC,KAAKT,KAAKR,iBAAkBQ,KAAKK,kBAElDL,KAAKU,oBAAsBV,KAAKK,iBAEhCL,KAAKW,kBAAoB,EACzBX,KAAKY,eAAiB,EACtBZ,KAAKa,eAAiB,EACtBb,KAAKc,cAAgB,EAErBd,KAAKe,oBArGEC,sBACP,OAAOhB,KAAKR,iBAGLwB,oBAAgBC,GACvBjB,KAAKR,iBAAmByB,EACxBjB,KAAKe,oBAqBExB,WACP,OAAOS,KAAKM,MAGLf,SAAK2B,GACZ,IAAK,IAAIC,EAAI,EAAGA,EAAInB,KAAKI,WAAWgB,SAAUD,EAC1CnB,KAAKI,WAAWe,GAAG5B,KAAO2B,EAI1BH,oBACJf,KAAKW,kBAAoBX,KAAKR,iBAAmBQ,KAAKR,iBACtDQ,KAAKY,eACD,KAAO,GAAKS,KAAKC,GAAKD,KAAKE,IAAIvB,KAAKR,iBAAkB,IAC1DQ,KAAKa,gBACA,IAAMQ,KAAKC,GAAKD,KAAKE,IAAIvB,KAAKR,iBAAkB,IACrDQ,KAAKc,cACD,IAAMO,KAAKC,GAAKD,KAAKE,IAAIvB,KAAKR,iBAAkB,IACpDQ,KAAKQ,MAAQ,IAAI,EAAAC,KAAKT,KAAKR,iBAAkBQ,KAAKK,kBAG3ChB,gBACP,OAAOW,KAAKC,WAGLX,iBACP,OAAOU,KAAKG,YAGLqB,sBACP,OAAOxB,KAAKK,iBAGTE,gBACHlB,EACAC,GAEAU,KAAKC,WAAaZ,MAAAA,EAAAA,EAAa,IAAIoC,aACnCzB,KAAKG,YAAcb,MAAAA,EAAAA,EAAc,IAAImC,aACrCzB,KAAKK,iBAAmBL,KAAKC,WAAWmB,OAAS,EACjDpB,KAAKQ,MAAQ,IAAI,EAAAC,KAAKT,KAAKR,iBAAkBQ,KAAKK,kBAElD,IAAK,IAAIc,EAAInB,KAAKI,WAAWgB,OAAQD,EAAInB,KAAKK,mBAAoBc,EAC9DnB,KAAKI,WAAWsB,KAAK,CACjBnC,KAAMS,KAAKT,KACXoC,QAAS,EACTC,SAAU,EACVC,OAAQ,EACRC,OAAQ,EACRC,OAAQ,IA4BbC,OAAOC,GACV,IAAIC,EAAWD,EAEf,KAAOC,EAAW,GAAG,CACjBlC,KAAKQ,MAAM2B,OAAOnC,KAAKC,WAAYD,KAAKU,qBACxCV,KAAKoC,6BACLpC,KAAKqC,uBAEL,IAAIC,EAAWtC,KAAKuC,qBAEpBL,GAAYI,EACRJ,EAAW,IACXI,GAAYJ,EACZA,EAAW,GAGflC,KAAKwC,iBAAiBF,IAIvBG,WAIGL,6BACN,IAAK,IAAIM,EAAI,EAAGA,EAAI1C,KAAKU,sBAAuBgC,EAAG,CAC/C,MAAMC,EAAK3C,KAAKI,WAAWsC,GACrBE,EAAM5C,KAAKC,WAAe,EAAJyC,EAAQ,GAC9BG,EAAM7C,KAAKC,WAAe,EAAJyC,EAAQ,GAC9BI,EAAM9C,KAAKC,WAAe,EAAJyC,EAAQ,GAEpCC,EAAGhB,QAAU,EAEb3B,KAAKQ,MAAMuC,MAAM/C,KAAKC,WAAYyC,EAAG1C,KAAKR,kBAE1C,IAAK,IAAIwD,EAAK,EAAGA,EAAKhD,KAAKQ,MAAMyC,YAAaD,EAAI,CAC9C,MAAME,EAAIlD,KAAKQ,MAAM2C,SAASH,GACxBI,EAAQR,EAAM5C,KAAKC,WAAe,EAAJiD,EAAQ,GACtCG,EAAQR,EAAM7C,KAAKC,WAAe,EAAJiD,EAAQ,GACtCI,EAAQR,EAAM9C,KAAKC,WAAe,EAAJiD,EAAQ,GACtCK,EAAKH,EAAQA,EAAQC,EAAQA,EAAQC,EAAQA,EAEnD,GAAIC,EAAKvD,KAAKW,kBAAmB,CAC7B,MAAM6C,EACFxD,KAAKY,eACLS,KAAKE,IAAIvB,KAAKW,kBAAoB4C,EAAI,GAC1CZ,EAAGhB,SAAW6B,GAItBb,EAAGhB,QAAUN,KAAKoC,IAAIzD,KAAKP,iBAAkBkD,EAAGhB,SAChDgB,EAAGf,SACC5B,KAAKN,kBAAoBiD,EAAGhB,QAAU3B,KAAKP,mBAI7C4C,uBAEN,IAAK,IAAIK,EAAI,EAAGA,EAAI1C,KAAKU,sBAAuBgC,EAAG,CAC/C,MAAMC,EAAK3C,KAAKI,WAAWsC,GACrBE,EAAM5C,KAAKC,WAAe,EAAJyC,EAAQ,GAC9BG,EAAM7C,KAAKC,WAAe,EAAJyC,EAAQ,GAC9BI,EAAM9C,KAAKC,WAAe,EAAJyC,EAAQ,GAE9BgB,EAAM1D,KAAKG,YAAgB,EAAJuC,EAAQ,GAC/BiB,EAAM3D,KAAKG,YAAgB,EAAJuC,EAAQ,GAC/BkB,EAAM5D,KAAKG,YAAgB,EAAJuC,EAAQ,GAErC,IAAImB,EAAiB,EACjBC,EAAiB,EACjBC,EAAiB,EAEjBC,EAAkB,EAClBC,EAAkB,EAClBC,EAAkB,EAEtBlE,KAAKQ,MAAMuC,MAAM/C,KAAKC,WAAYyC,EAAG1C,KAAKR,kBAE1C,IAAK,IAAIwD,EAAK,EAAGA,EAAKhD,KAAKQ,MAAMyC,YAAaD,EAAI,CAC9C,MAAME,EAAIlD,KAAKQ,MAAM2C,SAASH,GAC9B,IAAII,EAAQR,EAAM5C,KAAKC,WAAe,EAAJiD,EAAQ,GACtCG,EAAQR,EAAM7C,KAAKC,WAAe,EAAJiD,EAAQ,GACtCI,EAAQR,EAAM9C,KAAKC,WAAe,EAAJiD,EAAQ,GAC1C,MAAMK,EAAKH,EAAQA,EAAQC,EAAQA,EAAQC,EAAQA,EAC7Ca,EAAI9C,KAAK+C,KAAKb,GAEpB,GAAIY,EAAI,GAAKZ,EAAKvD,KAAKW,kBAAmB,CACtC,MAAM0D,EAAKrE,KAAKI,WAAW8C,GAE3BE,GAASe,EACTd,GAASc,EACTb,GAASa,EAET,MAAMX,EACFxD,KAAKa,gBACJb,KAAKR,iBAAmB2E,IACxBnE,KAAKR,iBAAmB2E,GACvBG,EAAYD,EAAG9E,KAAOoD,EAAGpD,KACzBgF,EACFf,IACEb,EAAGf,SAAWyC,EAAGzC,WACd,EAAIe,EAAGhB,QAAU0C,EAAG1C,UACzB2C,EAEJT,GAAkBU,EAAKnB,EACvBU,GAAkBS,EAAKlB,EACvBU,GAAkBQ,EAAKjB,EAEvB,MACMkB,EADKxE,KAAKc,eAAiBd,KAAKR,iBAAmB2E,IAE/C,EAAIE,EAAG1C,SAAW2C,EAAYtE,KAAKL,UAE7CqE,GAAmBQ,GAAMxE,KAAKG,YAAgB,EAAJ+C,EAAQ,GAAKQ,GACvDO,GAAmBO,GAAMxE,KAAKG,YAAgB,EAAJ+C,EAAQ,GAAKS,GACvDO,GAAmBM,GAAMxE,KAAKG,YAAgB,EAAJ+C,EAAQ,GAAKU,IAI/DjB,EAAGd,OAASgC,EAAiBG,EAC7BrB,EAAGb,OAASgC,EAAiBG,EAC7BtB,EAAGZ,OAASgC,EAAiBG,EAE7BvB,EAAGd,QAAU7B,KAAKJ,QAAQ6E,EAC1B9B,EAAGb,QAAU9B,KAAKJ,QAAQ8E,EAC1B/B,EAAGZ,QAAU/B,KAAKJ,QAAQ+E,EAE1B,MAAMC,EAAMvD,KAAK+C,KACbzB,EAAGd,OAASc,EAAGd,OACXc,EAAGb,OAASa,EAAGb,OACfa,EAAGZ,OAASY,EAAGZ,QAGnB6C,EAAM5E,KAAKD,kBACX4C,EAAGd,OAAUc,EAAGd,OAAS+C,EAAO5E,KAAKD,gBACrC4C,EAAGb,OAAUa,EAAGb,OAAS8C,EAAO5E,KAAKD,gBACrC4C,EAAGZ,OAAUY,EAAGZ,OAAS6C,EAAO5E,KAAKD,kBAKvCwC,qBACN,IAAIzC,EAAc,EACdC,EAAkB,EAClB8E,EAAkB,EAEtB,IAAK,IAAInC,EAAI,EAAGA,EAAI1C,KAAKU,sBAAuBgC,EAAG,CAC/C,MAAMC,EAAK3C,KAAKI,WAAWsC,GAErBoC,EACF9E,KAAKG,YAAgB,EAAJuC,EAAQ,GAAK1C,KAAKG,YAAgB,EAAJuC,EAAQ,GACvD1C,KAAKG,YAAgB,EAAJuC,EAAQ,GAAK1C,KAAKG,YAAgB,EAAJuC,EAAQ,GACvD1C,KAAKG,YAAgB,EAAJuC,EAAQ,GAAK1C,KAAKG,YAAgB,EAAJuC,EAAQ,GACrDqC,EACFpC,EAAGd,OAASc,EAAGd,OACfc,EAAGb,OAASa,EAAGb,OACfa,EAAGZ,OAASY,EAAGZ,OACbiD,EAAQrC,EAAGhB,QAAU,KAAU,EAAIgB,EAAGf,SAAWe,EAAGhB,QAEtDmD,EAAQhF,IACRA,EAAcgF,GAEdC,EAAQhF,IACRA,EAAkBgF,GAElBC,EAAQH,IACRA,EAAkBG,GAI1BlF,EAAcuB,KAAK+C,KAAKtE,GACxBC,EAAkBsB,KAAK+C,KAAKrE,GAC5B8E,EAAkBxD,KAAK+C,KAAKS,GAE5B,MAAMI,EAAW,GAAMjF,KAAKgB,gBAAmBK,KAAKoC,IAAI,EAAG3D,GACrDoF,EAAU,GAAM7D,KAAK+C,KAAKpE,KAAKgB,gBAAkBjB,GACjDoF,EAAUnF,KAAKgB,gBAAkB6D,EAEvC,OAAOxD,KAAKoC,IAAIzD,KAAKH,YAAawB,KAAK+D,IAAIH,EAASC,EAASC,IAGvD3C,iBAAiBP,GACvB,IAAK,IAAIS,EAAI,EAAGA,EAAI1C,KAAKU,sBAAuBgC,EAAG,CAC/C,MAAMC,EAAK3C,KAAKI,WAAWsC,GAE3B1C,KAAKG,YAAgB,EAAJuC,EAAQ,IAAMC,EAAGd,OAASI,EAC3CjC,KAAKG,YAAgB,EAAJuC,EAAQ,IAAMC,EAAGb,OAASG,EAC3CjC,KAAKG,YAAgB,EAAJuC,EAAQ,IAAMC,EAAGZ,OAASE,EAE3C,MAAM2C,EAAMvD,KAAK+C,KACbpE,KAAKG,YAAgB,EAAJuC,EAAQ,GAAK1C,KAAKG,YAAgB,EAAJuC,EAAQ,GACnD1C,KAAKG,YAAgB,EAAJuC,EAAQ,GAAK1C,KAAKG,YAAgB,EAAJuC,EAAQ,GACvD1C,KAAKG,YAAgB,EAAJuC,EAAQ,GAAK1C,KAAKG,YAAgB,EAAJuC,EAAQ,IAG3DkC,EAAM5E,KAAKF,cACXE,KAAKG,YAAgB,EAAJuC,EAAQ,GACpB1C,KAAKG,YAAgB,EAAJuC,EAAQ,GAAKkC,EAAO5E,KAAKF,YAC/CE,KAAKG,YAAgB,EAAJuC,EAAQ,GACpB1C,KAAKG,YAAgB,EAAJuC,EAAQ,GAAKkC,EAAO5E,KAAKF,YAC/CE,KAAKG,YAAgB,EAAJuC,EAAQ,GACpB1C,KAAKG,YAAgB,EAAJuC,EAAQ,GAAKkC,EAAO5E,KAAKF,aAGnDE,KAAKC,WAAe,EAAJyC,EAAQ,IACpBT,EAAYjC,KAAKG,YAAgB,EAAJuC,EAAQ,GACzC1C,KAAKC,WAAe,EAAJyC,EAAQ,IACpBT,EAAYjC,KAAKG,YAAgB,EAAJuC,EAAQ,GACzC1C,KAAKC,WAAe,EAAJyC,EAAQ,IACpBT,EAAYjC,KAAKG,YAAgB,EAAJuC,EAAQ,O,0CChV9C,MAAMjC,EAgBTrB,YAAYiG,EAAiBC,GACzBtF,KAAKuF,SAAWF,EAChBrF,KAAKwF,WAAa,EAAIF,EACtBtF,KAAKyF,WAAa,IAAIC,WAAW1F,KAAKwF,WAAa,GACnDxF,KAAK2F,aAAe,IAAID,WAAWJ,GACnCtF,KAAK4F,UAAY,IAAIF,WAAWJ,GAChCtF,KAAK6F,WAAa,EAdX5C,gBACP,OAAOjD,KAAK6F,WAGL1C,eACP,OAAOnD,KAAK4F,UAYTE,WAAWC,EAAYC,EAAYC,GACtC,MAAMC,EAAU,SAALH,EAAuB,UAALC,EAAwB,UAALC,EAEhD,OAAO5E,KAAK8E,IAAID,GAAKlG,KAAKwF,WAGvBY,SAASC,GACZ,OAAOhF,KAAKiF,MAAMD,EAAQrG,KAAKuF,UAG5BgB,QAAQC,EAA8BC,GACzC,OAAOzG,KAAK8F,WACR9F,KAAKoG,SAASI,EAAI,EAAIC,IACtBzG,KAAKoG,SAASI,EAAI,EAAIC,EAAK,IAC3BzG,KAAKoG,SAASI,EAAI,EAAIC,EAAK,KAI5BtE,OAAOqE,EAA8BE,GACxCA,EAAcA,MAAAA,EAAAA,EAAeF,EAAIpF,OAAS,EAE1C,MAAMuF,EAAatF,KAAK+D,IAAIsB,EAAa1G,KAAK2F,aAAavE,QAG3DpB,KAAKyF,WAAWmB,KAAK,GACrB5G,KAAK2F,aAAaiB,KAAK,GAEvB,IAAK,IAAIzF,EAAI,EAAGA,EAAIwF,EAAYxF,IAAK,CACjC,MAAM+E,EAAIlG,KAAKuG,QAAQC,EAAKrF,GAC5BnB,KAAKyF,WAAWS,KAIpB,IAAIW,EAAQ,EACZ,IAAK,IAAI1F,EAAI,EAAGA,EAAInB,KAAKwF,WAAYrE,IACjC0F,GAAS7G,KAAKyF,WAAWtE,GACzBnB,KAAKyF,WAAWtE,GAAK0F,EAEzB7G,KAAKyF,WAAWzF,KAAKwF,YAAcqB,EAGnC,IAAK,IAAI1F,EAAI,EAAGA,EAAIwF,EAAYxF,IAAK,CACjC,MAAM+E,EAAIlG,KAAKuG,QAAQC,EAAKrF,GAC5BnB,KAAKyF,WAAWS,KAChBlG,KAAK2F,aAAa3F,KAAKyF,WAAWS,IAAM/E,GAIzC4B,MAAMyD,EAA8BC,EAAYK,GACnD,MAAMC,EAAK/G,KAAKoG,SAASI,EAAI,EAAIC,GAAMK,GACjCE,EAAKhH,KAAKoG,SAASI,EAAI,EAAIC,EAAK,GAAKK,GACrCG,EAAKjH,KAAKoG,SAASI,EAAI,EAAIC,EAAK,GAAKK,GAErCI,EAAKlH,KAAKoG,SAASI,EAAI,EAAIC,GAAMK,GACjCK,EAAKnH,KAAKoG,SAASI,EAAI,EAAIC,EAAK,GAAKK,GACrCM,EAAKpH,KAAKoG,SAASI,EAAI,EAAIC,EAAK,GAAKK,GAE3C9G,KAAK6F,WAAa,EAElB,IAAK,IAAIE,EAAKgB,EAAIhB,GAAMmB,EAAInB,IACxB,IAAK,IAAIC,EAAKgB,EAAIhB,GAAMmB,EAAInB,IACxB,IAAK,IAAIC,EAAKgB,EAAIhB,GAAMmB,EAAInB,IAAM,CAC9B,MAAMC,EAAIlG,KAAK8F,WAAWC,EAAIC,EAAIC,GAC5BY,EAAQ7G,KAAKyF,WAAWS,GACxBmB,EAAMrH,KAAKyF,WAAWS,EAAI,GAEhC,IAAK,IAAI/E,EAAI0F,EAAO1F,EAAIkG,EAAKlG,IACzBnB,KAAK4F,UAAU5F,KAAK6F,YAAc7F,KAAK2F,aAAaxE,GACpDnB,KAAK6F","sources":["webpack://babylonjs-fluid-rendering/./src/scenes/FluidSimulator2/fluidSimulator.ts","webpack://babylonjs-fluid-rendering/./src/scenes/FluidSimulator2/hash.ts"],"sourcesContent":["import * as BABYLON from \"@babylonjs/core\";\r\nimport { Hash } from \"./hash\";\r\n\r\n// Based on https://github.com/rlguy/SPHFluidSim/blob/master/src/sphfluidsimulation.cpp\r\n\r\nexport interface IFluidParticle {\r\n    mass: number;\r\n    density: number;\r\n    pressure: number;\r\n    accelX: number;\r\n    accelY: number;\r\n    accelZ: number;\r\n}\r\n\r\nexport class FluidSimulator {\r\n    protected _particles: IFluidParticle[];\r\n    protected _numMaxParticles: number;\r\n    protected _positions: Float32Array;\r\n    protected _velocities: Float32Array;\r\n    protected _hash: Hash;\r\n\r\n    protected _smoothingRadius2: number;\r\n    protected _poly6Constant: number;\r\n    protected _spikyConstant: number;\r\n    protected _viscConstant: number;\r\n\r\n    protected _smoothingRadius = 0.2;\r\n\r\n    public get smoothingRadius() {\r\n        return this._smoothingRadius;\r\n    }\r\n\r\n    public set smoothingRadius(radius: number) {\r\n        this._smoothingRadius = radius;\r\n        this._computeConstants();\r\n    }\r\n\r\n    public densityReference = 2000;\r\n\r\n    public pressureConstant = 20;\r\n\r\n    public viscosity = 0.005;\r\n\r\n    public gravity = new BABYLON.Vector3(0, -9.8, 0);\r\n\r\n    public minTimeStep = 1 / 100;\r\n\r\n    public maxVelocity = 75;\r\n\r\n    public maxAcceleration = 2000;\r\n\r\n    public currentNumParticles: number;\r\n\r\n    private _mass: number;\r\n\r\n    public get mass() {\r\n        return this._mass;\r\n    }\r\n\r\n    public set mass(m: number) {\r\n        for (let i = 0; i < this._particles.length; ++i) {\r\n            this._particles[i].mass = m;\r\n        }\r\n    }\r\n\r\n    private _computeConstants(): void {\r\n        this._smoothingRadius2 = this._smoothingRadius * this._smoothingRadius;\r\n        this._poly6Constant =\r\n            315 / (64 * Math.PI * Math.pow(this._smoothingRadius, 9));\r\n        this._spikyConstant =\r\n            -45 / (Math.PI * Math.pow(this._smoothingRadius, 6));\r\n        this._viscConstant =\r\n            45 / (Math.PI * Math.pow(this._smoothingRadius, 6));\r\n        this._hash = new Hash(this._smoothingRadius, this._numMaxParticles);\r\n    }\r\n\r\n    public get positions() {\r\n        return this._positions;\r\n    }\r\n\r\n    public get velocities() {\r\n        return this._velocities;\r\n    }\r\n\r\n    public get numMaxParticles() {\r\n        return this._numMaxParticles;\r\n    }\r\n\r\n    public setParticleData(\r\n        positions?: Float32Array,\r\n        velocities?: Float32Array\r\n    ): void {\r\n        this._positions = positions ?? new Float32Array();\r\n        this._velocities = velocities ?? new Float32Array();\r\n        this._numMaxParticles = this._positions.length / 3;\r\n        this._hash = new Hash(this._smoothingRadius, this._numMaxParticles);\r\n\r\n        for (let i = this._particles.length; i < this._numMaxParticles; ++i) {\r\n            this._particles.push({\r\n                mass: this.mass,\r\n                density: 0,\r\n                pressure: 0,\r\n                accelX: 0,\r\n                accelY: 0,\r\n                accelZ: 0,\r\n            });\r\n        }\r\n    }\r\n\r\n    constructor(positions?: Float32Array, velocities?: Float32Array, mass = 1) {\r\n        this._positions = undefined as any;\r\n        this._velocities = undefined as any;\r\n        this._particles = [];\r\n        this._numMaxParticles = 0;\r\n        this._mass = mass;\r\n\r\n        if (positions && velocities) {\r\n            this.setParticleData(positions, velocities);\r\n        }\r\n\r\n        this._hash = new Hash(this._smoothingRadius, this._numMaxParticles);\r\n\r\n        this.currentNumParticles = this._numMaxParticles;\r\n\r\n        this._smoothingRadius2 = 0;\r\n        this._poly6Constant = 0;\r\n        this._spikyConstant = 0;\r\n        this._viscConstant = 0;\r\n\r\n        this._computeConstants();\r\n    }\r\n\r\n    public update(deltaTime: number): void {\r\n        let timeLeft = deltaTime;\r\n\r\n        while (timeLeft > 0) {\r\n            this._hash.create(this._positions, this.currentNumParticles);\r\n            this._computeDensityAndPressure();\r\n            this._computeAcceleration();\r\n\r\n            let timeStep = this._calculateTimeStep();\r\n\r\n            timeLeft -= timeStep;\r\n            if (timeLeft < 0) {\r\n                timeStep += timeLeft;\r\n                timeLeft = 0;\r\n            }\r\n\r\n            this._updatePositions(timeStep);\r\n        }\r\n    }\r\n\r\n    public dispose(): void {\r\n        // nothing to do\r\n    }\r\n\r\n    protected _computeDensityAndPressure(): void {\r\n        for (let a = 0; a < this.currentNumParticles; ++a) {\r\n            const pA = this._particles[a];\r\n            const paX = this._positions[a * 3 + 0];\r\n            const paY = this._positions[a * 3 + 1];\r\n            const paZ = this._positions[a * 3 + 2];\r\n\r\n            pA.density = 0;\r\n\r\n            this._hash.query(this._positions, a, this._smoothingRadius);\r\n\r\n            for (let ib = 0; ib < this._hash.querySize; ++ib) {\r\n                const b = this._hash.queryIds[ib];\r\n                const diffX = paX - this._positions[b * 3 + 0];\r\n                const diffY = paY - this._positions[b * 3 + 1];\r\n                const diffZ = paZ - this._positions[b * 3 + 2];\r\n                const r2 = diffX * diffX + diffY * diffY + diffZ * diffZ;\r\n\r\n                if (r2 < this._smoothingRadius2) {\r\n                    const w =\r\n                        this._poly6Constant *\r\n                        Math.pow(this._smoothingRadius2 - r2, 3);\r\n                    pA.density += w;\r\n                }\r\n            }\r\n\r\n            pA.density = Math.max(this.densityReference, pA.density);\r\n            pA.pressure =\r\n                this.pressureConstant * (pA.density - this.densityReference);\r\n        }\r\n    }\r\n\r\n    protected _computeAcceleration(): void {\r\n        // Pressurce-based acceleration + viscosity-based acceleration computation\r\n        for (let a = 0; a < this.currentNumParticles; ++a) {\r\n            const pA = this._particles[a];\r\n            const paX = this._positions[a * 3 + 0];\r\n            const paY = this._positions[a * 3 + 1];\r\n            const paZ = this._positions[a * 3 + 2];\r\n\r\n            const vaX = this._velocities[a * 3 + 0];\r\n            const vaY = this._velocities[a * 3 + 1];\r\n            const vaZ = this._velocities[a * 3 + 2];\r\n\r\n            let pressureAccelX = 0;\r\n            let pressureAccelY = 0;\r\n            let pressureAccelZ = 0;\r\n\r\n            let viscosityAccelX = 0;\r\n            let viscosityAccelY = 0;\r\n            let viscosityAccelZ = 0;\r\n\r\n            this._hash.query(this._positions, a, this._smoothingRadius);\r\n\r\n            for (let ib = 0; ib < this._hash.querySize; ++ib) {\r\n                const b = this._hash.queryIds[ib];\r\n                let diffX = paX - this._positions[b * 3 + 0];\r\n                let diffY = paY - this._positions[b * 3 + 1];\r\n                let diffZ = paZ - this._positions[b * 3 + 2];\r\n                const r2 = diffX * diffX + diffY * diffY + diffZ * diffZ;\r\n                const r = Math.sqrt(r2);\r\n\r\n                if (r > 0 && r2 < this._smoothingRadius2) {\r\n                    const pB = this._particles[b];\r\n\r\n                    diffX /= r;\r\n                    diffY /= r;\r\n                    diffZ /= r;\r\n\r\n                    const w =\r\n                        this._spikyConstant *\r\n                        (this._smoothingRadius - r) *\r\n                        (this._smoothingRadius - r);\r\n                    const massRatio = pB.mass / pA.mass;\r\n                    const fp =\r\n                        w *\r\n                        ((pA.pressure + pB.pressure) /\r\n                            (2 * pA.density * pB.density)) *\r\n                        massRatio;\r\n\r\n                    pressureAccelX -= fp * diffX;\r\n                    pressureAccelY -= fp * diffY;\r\n                    pressureAccelZ -= fp * diffZ;\r\n\r\n                    const w2 = this._viscConstant * (this._smoothingRadius - r);\r\n                    const fv =\r\n                        w2 * (1 / pB.density) * massRatio * this.viscosity;\r\n\r\n                    viscosityAccelX += fv * (this._velocities[b * 3 + 0] - vaX);\r\n                    viscosityAccelY += fv * (this._velocities[b * 3 + 1] - vaY);\r\n                    viscosityAccelZ += fv * (this._velocities[b * 3 + 2] - vaZ);\r\n                }\r\n            }\r\n\r\n            pA.accelX = pressureAccelX + viscosityAccelX;\r\n            pA.accelY = pressureAccelY + viscosityAccelY;\r\n            pA.accelZ = pressureAccelZ + viscosityAccelZ;\r\n\r\n            pA.accelX += this.gravity.x;\r\n            pA.accelY += this.gravity.y;\r\n            pA.accelZ += this.gravity.z;\r\n\r\n            const mag = Math.sqrt(\r\n                pA.accelX * pA.accelX +\r\n                    pA.accelY * pA.accelY +\r\n                    pA.accelZ * pA.accelZ\r\n            );\r\n\r\n            if (mag > this.maxAcceleration) {\r\n                pA.accelX = (pA.accelX / mag) * this.maxAcceleration;\r\n                pA.accelY = (pA.accelY / mag) * this.maxAcceleration;\r\n                pA.accelZ = (pA.accelZ / mag) * this.maxAcceleration;\r\n            }\r\n        }\r\n    }\r\n\r\n    protected _calculateTimeStep() {\r\n        let maxVelocity = 0;\r\n        let maxAcceleration = 0;\r\n        let maxSpeedOfSound = 0;\r\n\r\n        for (let a = 0; a < this.currentNumParticles; ++a) {\r\n            const pA = this._particles[a];\r\n\r\n            const velSq =\r\n                this._velocities[a * 3 + 0] * this._velocities[a * 3 + 0] +\r\n                this._velocities[a * 3 + 1] * this._velocities[a * 3 + 1] +\r\n                this._velocities[a * 3 + 2] * this._velocities[a * 3 + 2];\r\n            const accSq =\r\n                pA.accelX * pA.accelX +\r\n                pA.accelY * pA.accelY +\r\n                pA.accelZ * pA.accelZ;\r\n            const spsSq = pA.density < 0.00001 ? 0 : pA.pressure / pA.density;\r\n\r\n            if (velSq > maxVelocity) {\r\n                maxVelocity = velSq;\r\n            }\r\n            if (accSq > maxAcceleration) {\r\n                maxAcceleration = accSq;\r\n            }\r\n            if (spsSq > maxSpeedOfSound) {\r\n                maxSpeedOfSound = spsSq;\r\n            }\r\n        }\r\n\r\n        maxVelocity = Math.sqrt(maxVelocity);\r\n        maxAcceleration = Math.sqrt(maxAcceleration);\r\n        maxSpeedOfSound = Math.sqrt(maxSpeedOfSound);\r\n\r\n        const velStep = (0.4 * this.smoothingRadius) / Math.max(1, maxVelocity);\r\n        const accStep = 0.4 * Math.sqrt(this.smoothingRadius / maxAcceleration);\r\n        const spsStep = this.smoothingRadius / maxSpeedOfSound;\r\n\r\n        return Math.max(this.minTimeStep, Math.min(velStep, accStep, spsStep));\r\n    }\r\n\r\n    protected _updatePositions(deltaTime: number): void {\r\n        for (let a = 0; a < this.currentNumParticles; ++a) {\r\n            const pA = this._particles[a];\r\n\r\n            this._velocities[a * 3 + 0] += pA.accelX * deltaTime;\r\n            this._velocities[a * 3 + 1] += pA.accelY * deltaTime;\r\n            this._velocities[a * 3 + 2] += pA.accelZ * deltaTime;\r\n\r\n            const mag = Math.sqrt(\r\n                this._velocities[a * 3 + 0] * this._velocities[a * 3 + 0] +\r\n                    this._velocities[a * 3 + 1] * this._velocities[a * 3 + 1] +\r\n                    this._velocities[a * 3 + 2] * this._velocities[a * 3 + 2]\r\n            );\r\n\r\n            if (mag > this.maxVelocity) {\r\n                this._velocities[a * 3 + 0] =\r\n                    (this._velocities[a * 3 + 0] / mag) * this.maxVelocity;\r\n                this._velocities[a * 3 + 1] =\r\n                    (this._velocities[a * 3 + 1] / mag) * this.maxVelocity;\r\n                this._velocities[a * 3 + 2] =\r\n                    (this._velocities[a * 3 + 2] / mag) * this.maxVelocity;\r\n            }\r\n\r\n            this._positions[a * 3 + 0] +=\r\n                deltaTime * this._velocities[a * 3 + 0];\r\n            this._positions[a * 3 + 1] +=\r\n                deltaTime * this._velocities[a * 3 + 1];\r\n            this._positions[a * 3 + 2] +=\r\n                deltaTime * this._velocities[a * 3 + 2];\r\n        }\r\n    }\r\n}\r\n","/**\r\n * From https://github.com/matthias-research/pages/blob/master/tenMinutePhysics/11-hashing.html\r\n */\r\n\r\nexport class Hash {\r\n    private _spacing: number;\r\n    private _tableSize: number;\r\n    private _cellStart: Int32Array;\r\n    private _cellEntries: Int32Array;\r\n    private _queryIds: Int32Array;\r\n    private _querySize: number;\r\n\r\n    public get querySize() {\r\n        return this._querySize;\r\n    }\r\n\r\n    public get queryIds() {\r\n        return this._queryIds;\r\n    }\r\n\r\n    constructor(spacing: number, maxNumObjects: number) {\r\n        this._spacing = spacing;\r\n        this._tableSize = 2 * maxNumObjects;\r\n        this._cellStart = new Int32Array(this._tableSize + 1);\r\n        this._cellEntries = new Int32Array(maxNumObjects);\r\n        this._queryIds = new Int32Array(maxNumObjects);\r\n        this._querySize = 0;\r\n    }\r\n\r\n    public hashCoords(xi: number, yi: number, zi: number) {\r\n        const h = (xi * 92837111) ^ (yi * 689287499) ^ (zi * 283923481); // fantasy function\r\n        //const h = (xi * 73856093) ^ (yi * 19349663) ^ (zi * 83492791); // fantasy function\r\n        return Math.abs(h) % this._tableSize;\r\n    }\r\n\r\n    public intCoord(coord: number) {\r\n        return Math.floor(coord / this._spacing);\r\n    }\r\n\r\n    public hashPos(pos: number[] | Float32Array, nr: number) {\r\n        return this.hashCoords(\r\n            this.intCoord(pos[3 * nr]),\r\n            this.intCoord(pos[3 * nr + 1]),\r\n            this.intCoord(pos[3 * nr + 2])\r\n        );\r\n    }\r\n\r\n    public create(pos: number[] | Float32Array, numElements?: number) {\r\n        numElements = numElements ?? pos.length / 3;\r\n\r\n        const numObjects = Math.min(numElements, this._cellEntries.length);\r\n\r\n        // determine cell sizes\r\n        this._cellStart.fill(0);\r\n        this._cellEntries.fill(0);\r\n\r\n        for (let i = 0; i < numObjects; i++) {\r\n            const h = this.hashPos(pos, i);\r\n            this._cellStart[h]++;\r\n        }\r\n\r\n        // determine cells starts\r\n        let start = 0;\r\n        for (let i = 0; i < this._tableSize; i++) {\r\n            start += this._cellStart[i];\r\n            this._cellStart[i] = start;\r\n        }\r\n        this._cellStart[this._tableSize] = start; // guard\r\n\r\n        // fill in objects ids\r\n        for (let i = 0; i < numObjects; i++) {\r\n            const h = this.hashPos(pos, i);\r\n            this._cellStart[h]--;\r\n            this._cellEntries[this._cellStart[h]] = i;\r\n        }\r\n    }\r\n\r\n    public query(pos: number[] | Float32Array, nr: number, maxDist: number) {\r\n        const x0 = this.intCoord(pos[3 * nr] - maxDist);\r\n        const y0 = this.intCoord(pos[3 * nr + 1] - maxDist);\r\n        const z0 = this.intCoord(pos[3 * nr + 2] - maxDist);\r\n\r\n        const x1 = this.intCoord(pos[3 * nr] + maxDist);\r\n        const y1 = this.intCoord(pos[3 * nr + 1] + maxDist);\r\n        const z1 = this.intCoord(pos[3 * nr + 2] + maxDist);\r\n\r\n        this._querySize = 0;\r\n\r\n        for (let xi = x0; xi <= x1; xi++) {\r\n            for (let yi = y0; yi <= y1; yi++) {\r\n                for (let zi = z0; zi <= z1; zi++) {\r\n                    const h = this.hashCoords(xi, yi, zi);\r\n                    const start = this._cellStart[h];\r\n                    const end = this._cellStart[h + 1];\r\n\r\n                    for (let i = start; i < end; i++) {\r\n                        this._queryIds[this._querySize] = this._cellEntries[i];\r\n                        this._querySize++;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n"],"names":["FluidSimulator","constructor","positions","velocities","mass","_smoothingRadius","densityReference","pressureConstant","viscosity","gravity","minTimeStep","maxVelocity","maxAcceleration","this","_positions","undefined","_velocities","_particles","_numMaxParticles","_mass","setParticleData","_hash","Hash","currentNumParticles","_smoothingRadius2","_poly6Constant","_spikyConstant","_viscConstant","_computeConstants","smoothingRadius","radius","m","i","length","Math","PI","pow","numMaxParticles","Float32Array","push","density","pressure","accelX","accelY","accelZ","update","deltaTime","timeLeft","create","_computeDensityAndPressure","_computeAcceleration","timeStep","_calculateTimeStep","_updatePositions","dispose","a","pA","paX","paY","paZ","query","ib","querySize","b","queryIds","diffX","diffY","diffZ","r2","w","max","vaX","vaY","vaZ","pressureAccelX","pressureAccelY","pressureAccelZ","viscosityAccelX","viscosityAccelY","viscosityAccelZ","r","sqrt","pB","massRatio","fp","fv","x","y","z","mag","maxSpeedOfSound","velSq","accSq","spsSq","velStep","accStep","spsStep","min","spacing","maxNumObjects","_spacing","_tableSize","_cellStart","Int32Array","_cellEntries","_queryIds","_querySize","hashCoords","xi","yi","zi","h","abs","intCoord","coord","floor","hashPos","pos","nr","numElements","numObjects","fill","start","maxDist","x0","y0","z0","x1","y1","z1","end"],"sourceRoot":""}