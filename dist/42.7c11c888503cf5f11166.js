"use strict";(self.webpackChunkbabylonjs_fluid_rendering=self.webpackChunkbabylonjs_fluid_rendering||[]).push([[42,287],{4042:(t,s,i)=>{i.r(s),i.d(s,{FluidSimulator:()=>o});var e=i(6291),h=i(3287);class o{constructor(t,s,i=1){this._smoothingRadius=.2,this.densityReference=2e3,this.pressureConstant=20,this.viscosity=.005,this.gravity=new e.Vector3(0,-9.8,0),this.minTimeStep=.01,this.maxVelocity=75,this.maxAcceleration=2e3,this._positions=void 0,this._velocities=void 0,this._particles=[],this._numMaxParticles=0,this._mass=i,t&&s&&this.setParticleData(t,s),this._hash=new h.Hash(this._smoothingRadius,this._numMaxParticles),this.currentNumParticles=this._numMaxParticles,this._smoothingRadius2=0,this._poly6Constant=0,this._spikyConstant=0,this._viscConstant=0,this._computeConstants()}get smoothingRadius(){return this._smoothingRadius}set smoothingRadius(t){this._smoothingRadius=t,this._computeConstants()}get mass(){return this._mass}set mass(t){for(let s=0;s<this._particles.length;++s)this._particles[s].mass=t}_computeConstants(){this._smoothingRadius2=this._smoothingRadius*this._smoothingRadius,this._poly6Constant=315/(64*Math.PI*Math.pow(this._smoothingRadius,9)),this._spikyConstant=-45/(Math.PI*Math.pow(this._smoothingRadius,6)),this._viscConstant=45/(Math.PI*Math.pow(this._smoothingRadius,6)),this._hash=new h.Hash(this._smoothingRadius,this._numMaxParticles)}get positions(){return this._positions}get velocities(){return this._velocities}get numMaxParticles(){return this._numMaxParticles}setParticleData(t,s){this._positions=null!=t?t:new Float32Array,this._velocities=null!=s?s:new Float32Array,this._numMaxParticles=this._positions.length/3,this._hash=new h.Hash(this._smoothingRadius,this._numMaxParticles);for(let t=this._particles.length;t<this._numMaxParticles;++t)this._particles.push({mass:this.mass,density:0,pressure:0,accelX:0,accelY:0,accelZ:0})}update(t){let s=t;for(;s>0;){this._hash.create(this._positions,this.currentNumParticles),this._computeDensityAndPressure(),this._computeAcceleration();let t=this._calculateTimeStep();s-=t,s<0&&(t+=s,s=0),this._updatePositions(t)}}dispose(){}_computeDensityAndPressure(){for(let t=0;t<this.currentNumParticles;++t){const s=this._particles[t],i=this._positions[3*t+0],e=this._positions[3*t+1],h=this._positions[3*t+2];s.density=0,this._hash.query(this._positions,t,this._smoothingRadius);for(let t=0;t<this._hash.querySize;++t){const o=this._hash.queryIds[t],a=i-this._positions[3*o+0],c=e-this._positions[3*o+1],n=h-this._positions[3*o+2],l=a*a+c*c+n*n;if(l<this._smoothingRadius2){const t=this._poly6Constant*Math.pow(this._smoothingRadius2-l,3);s.density+=t}}s.density=Math.max(this.densityReference,s.density),s.pressure=this.pressureConstant*(s.density-this.densityReference)}}_computeAcceleration(){for(let t=0;t<this.currentNumParticles;++t){const s=this._particles[t],i=this._positions[3*t+0],e=this._positions[3*t+1],h=this._positions[3*t+2],o=this._velocities[3*t+0],a=this._velocities[3*t+1],c=this._velocities[3*t+2];let n=0,l=0,r=0,_=0,u=0,m=0;this._hash.query(this._positions,t,this._smoothingRadius);for(let t=0;t<this._hash.querySize;++t){const d=this._hash.queryIds[t];let p=i-this._positions[3*d+0],y=e-this._positions[3*d+1],g=h-this._positions[3*d+2];const v=p*p+y*y+g*g,M=Math.sqrt(v);if(M>0&&v<this._smoothingRadius2){const t=this._particles[d];p/=M,y/=M,g/=M;const i=this._spikyConstant*(this._smoothingRadius-M)*(this._smoothingRadius-M),e=t.mass/s.mass,h=i*((s.pressure+t.pressure)/(2*s.density*t.density))*e;n-=h*p,l-=h*y,r-=h*g;const v=this._viscConstant*(this._smoothingRadius-M)*(1/t.density)*e*this.viscosity;_+=v*(this._velocities[3*d+0]-o),u+=v*(this._velocities[3*d+1]-a),m+=v*(this._velocities[3*d+2]-c)}}s.accelX=n+_,s.accelY=l+u,s.accelZ=r+m,s.accelX+=this.gravity.x,s.accelY+=this.gravity.y,s.accelZ+=this.gravity.z;const d=Math.sqrt(s.accelX*s.accelX+s.accelY*s.accelY+s.accelZ*s.accelZ);d>this.maxAcceleration&&(s.accelX=s.accelX/d*this.maxAcceleration,s.accelY=s.accelY/d*this.maxAcceleration,s.accelZ=s.accelZ/d*this.maxAcceleration)}}_calculateTimeStep(){let t=0,s=0,i=0;for(let e=0;e<this.currentNumParticles;++e){const h=this._particles[e],o=this._velocities[3*e+0]*this._velocities[3*e+0]+this._velocities[3*e+1]*this._velocities[3*e+1]+this._velocities[3*e+2]*this._velocities[3*e+2],a=h.accelX*h.accelX+h.accelY*h.accelY+h.accelZ*h.accelZ,c=h.density<1e-5?0:h.pressure/h.density;o>t&&(t=o),a>s&&(s=a),c>i&&(i=c)}t=Math.sqrt(t),s=Math.sqrt(s),i=Math.sqrt(i);const e=.4*this.smoothingRadius/Math.max(1,t),h=.4*Math.sqrt(this.smoothingRadius/s),o=this.smoothingRadius/i;return Math.max(this.minTimeStep,Math.min(e,h,o))}_updatePositions(t){for(let s=0;s<this.currentNumParticles;++s){const i=this._particles[s];this._velocities[3*s+0]+=i.accelX*t,this._velocities[3*s+1]+=i.accelY*t,this._velocities[3*s+2]+=i.accelZ*t;const e=Math.sqrt(this._velocities[3*s+0]*this._velocities[3*s+0]+this._velocities[3*s+1]*this._velocities[3*s+1]+this._velocities[3*s+2]*this._velocities[3*s+2]);e>this.maxVelocity&&(this._velocities[3*s+0]=this._velocities[3*s+0]/e*this.maxVelocity,this._velocities[3*s+1]=this._velocities[3*s+1]/e*this.maxVelocity,this._velocities[3*s+2]=this._velocities[3*s+2]/e*this.maxVelocity),this._positions[3*s+0]+=t*this._velocities[3*s+0],this._positions[3*s+1]+=t*this._velocities[3*s+1],this._positions[3*s+2]+=t*this._velocities[3*s+2]}}}},3287:(t,s,i)=>{i.r(s),i.d(s,{Hash:()=>e});class e{constructor(t,s){this._spacing=t,this._tableSize=2*s,this._cellStart=new Int32Array(this._tableSize+1),this._cellEntries=new Int32Array(s),this._queryIds=new Int32Array(s),this._querySize=0}get querySize(){return this._querySize}get queryIds(){return this._queryIds}hashCoords(t,s,i){const e=92837111*t^689287499*s^283923481*i;return Math.abs(e)%this._tableSize}intCoord(t){return Math.floor(t/this._spacing)}hashPos(t,s){return this.hashCoords(this.intCoord(t[3*s]),this.intCoord(t[3*s+1]),this.intCoord(t[3*s+2]))}create(t,s){s=null!=s?s:t.length/3;const i=Math.min(s,this._cellEntries.length);this._cellStart.fill(0),this._cellEntries.fill(0);for(let s=0;s<i;s++){const i=this.hashPos(t,s);this._cellStart[i]++}let e=0;for(let t=0;t<this._tableSize;t++)e+=this._cellStart[t],this._cellStart[t]=e;this._cellStart[this._tableSize]=e;for(let s=0;s<i;s++){const i=this.hashPos(t,s);this._cellStart[i]--,this._cellEntries[this._cellStart[i]]=s}}query(t,s,i){const e=this.intCoord(t[3*s]-i),h=this.intCoord(t[3*s+1]-i),o=this.intCoord(t[3*s+2]-i),a=this.intCoord(t[3*s]+i),c=this.intCoord(t[3*s+1]+i),n=this.intCoord(t[3*s+2]+i);this._querySize=0;for(let t=e;t<=a;t++)for(let s=h;s<=c;s++)for(let i=o;i<=n;i++){const e=this.hashCoords(t,s,i),h=this._cellStart[e],o=this._cellStart[e+1];for(let t=h;t<o;t++)this._queryIds[this._querySize]=this._cellEntries[t],this._querySize++}}}}}]);
//# sourceMappingURL=42.7c11c888503cf5f11166.js.map