"use strict";(self.webpackChunkbabylonjs_fluid_rendering=self.webpackChunkbabylonjs_fluid_rendering||[]).push([[154],{154:(e,t,s)=>{s.r(t),s.d(t,{FluidRenderingOutput:()=>r});var i=s(4265);class r{constructor(e){this.diffuseColor=new i.Color3(1,1,1),this.particleSize=.75,this.particleThicknessAlpha=.075,this.generateDiffuseTexture=!1,this.dirLight=new i.Vector3(-2,-1,1).normalize(),this.debug=!0,this.enableBlur=!0,this.blurScale=2,this.blurKernel=60,this.onDisposeObservable=new i.Observable,this._mapSize=1024,this._scene=e,this._engine=e.getEngine(),this._invProjectionMatrix=new i.Matrix,this._invViewMatrix=new i.Matrix,this._depthClearColor=new i.Color4(1,0,0,1),this._thicknessClearColor=new i.Color4(0,0,0,1),this._depthEffectWrapper=null,this._rtDepth=null,this._textureDepth=null,this._rtDepthBlur=null,this._textureBlurredDepth=null,this._blurDepthPostProcesses=null,this._rtDiffuse=null,this._textureDiffuse=null,this._rtDiffuseBlur=null,this._textureBlurredDiffuse=null,this._blurDiffusePostProcesses=null,this._thicknessEffectWrapper=null,this._rtThickness=null,this._textureThickness=null,this._rtThicknessBlur=null,this._textureBlurredThickness=null,this._blurThicknessPostProcesses=null,this._renderPostProcess=null,this._passPostProcess=null,this._textureTypeFloat=i.Constants.TEXTURETYPE_FLOAT,this._textureTypeHalfFloat=i.Constants.TEXTURETYPE_HALF_FLOAT}get mapSize(){return this._mapSize}set mapSize(e){this._mapSize!==e&&(this._mapSize=e)}initialize(){if(this.dispose(),this._initializeDepthStep(),this.generateDiffuseTexture&&this._initializeDiffuseStep(),this._initializeThicknessStep(),this.enableBlur){const[e,t,s]=this._initializeBlurStep(this._textureDepth,this._textureTypeFloat,this.blurScale,"Depth");if(this._rtDepthBlur=e,this._textureBlurredDepth=t,this._blurDepthPostProcesses=s,this.generateDiffuseTexture){const[e,t,s]=this._initializeBlurStep(this._textureDiffuse,this._textureTypeHalfFloat,this.blurScale,"Diffuse",!0,!0);this._rtDiffuseBlur=e,this._textureBlurredDiffuse=t,this._blurDiffusePostProcesses=s}const[i,r,n]=this._initializeBlurStep(this._textureThickness,this._textureTypeHalfFloat,this.blurScale,"Thickness",!0);this._rtThicknessBlur=i,this._textureBlurredThickness=r,this._blurThicknessPostProcesses=n}this._initializeLiquidRenderingStep()}_initializeDepthStep(){this._depthEffectWrapper=new i.EffectWrapper({engine:this._engine,useShaderStore:!0,vertexShader:"fluidParticleDepth",fragmentShader:"fluidParticleDepth",attributeNames:["position","size","offset"],uniformNames:["view","projection"],samplerNames:[]}),this._rtDepth=this._engine.createRenderTargetTexture(this._mapSize,{generateMipMaps:!1,type:this._textureTypeFloat,format:i.Constants.TEXTUREFORMAT_R,samplingMode:i.Constants.TEXTURE_NEAREST_SAMPLINGMODE,generateDepthBuffer:!0,generateStencilBuffer:!1,samples:1});const e=this._rtDepth.texture;if(this._textureDepth=new i.ThinTexture(e),e.wrapU=i.Texture.CLAMP_ADDRESSMODE,e.wrapV=i.Texture.CLAMP_ADDRESSMODE,this.debug){const t=new i.Texture(null,this._scene);t.name="rttDepth",t._texture=e,t._texture.incrementReferences(),this.onDisposeObservable.add((()=>{t.dispose()}))}}_initializeThicknessStep(){const e=this._engine.getRenderWidth(),t=this._engine.getRenderHeight();this._thicknessEffectWrapper=new i.EffectWrapper({engine:this._engine,useShaderStore:!0,vertexShader:"fluidParticleThickness",fragmentShader:"fluidParticleThickness",attributeNames:["position","size","offset"],uniformNames:["view","projection","particleAlpha"],samplerNames:[]}),this._rtThickness=this._engine.createRenderTargetTexture({width:e,height:t},{generateMipMaps:!1,type:i.Constants.TEXTURETYPE_UNSIGNED_BYTE,format:i.Constants.TEXTUREFORMAT_R,samplingMode:i.Constants.TEXTURE_BILINEAR_SAMPLINGMODE,generateDepthBuffer:!0,generateStencilBuffer:!1,samples:1}),this._rtThickness.createDepthStencilTexture(0,!1,!1,1,i.Constants.TEXTUREFORMAT_DEPTH32_FLOAT);const s=this._rtThickness.texture;if(this._textureThickness=new i.ThinTexture(s),s.wrapU=i.Texture.CLAMP_ADDRESSMODE,s.wrapV=i.Texture.CLAMP_ADDRESSMODE,this.debug){const e=new i.Texture(null,this._scene);e.name="rttThickness",e._texture=s,e._texture.incrementReferences(),this.onDisposeObservable.add((()=>{e.dispose()}))}}_initializeDiffuseStep(){this._rtDiffuse=this._engine.createRenderTargetTexture(this._mapSize,{generateMipMaps:!1,type:this._textureTypeHalfFloat,format:i.Constants.TEXTUREFORMAT_RGBA,samplingMode:i.Constants.TEXTURE_BILINEAR_SAMPLINGMODE,generateDepthBuffer:!0,generateStencilBuffer:!1,samples:1});const e=this._rtDiffuse.texture;if(this._textureDiffuse=new i.ThinTexture(e),e.wrapU=i.Texture.CLAMP_ADDRESSMODE,e.wrapV=i.Texture.CLAMP_ADDRESSMODE,this.debug){const t=new i.Texture(null,this._scene);t.name="rttDiffuse",t._texture=e,t._texture.incrementReferences(),this.onDisposeObservable.add((()=>{t.dispose()}))}}_initializeBlurStep(e,t,s,r,n=!1,h=!1){const l=this._scene.getEngine(),a=Math.floor(this._mapSize/s),u=this._engine.createRenderTargetTexture(a,{generateMipMaps:!1,type:t,format:h?i.Constants.TEXTUREFORMAT_RGBA:i.Constants.TEXTUREFORMAT_R,samplingMode:i.Constants.TEXTURE_BILINEAR_SAMPLINGMODE,generateDepthBuffer:!1,generateStencilBuffer:!1,samples:1});let o=u.texture;if(o.wrapU=i.Texture.CLAMP_ADDRESSMODE,o.wrapV=i.Texture.CLAMP_ADDRESSMODE,this.debug){const e=new i.Texture(null,this._scene);e.name="rttBlurred"+r,e._texture=o,e._texture.incrementReferences(),this.onDisposeObservable.add((()=>{e.dispose()}))}const _=new i.PostProcess("BilateralBlurX",n?"standardBlur":"bilateralBlur",["filterRadius","blurScale","blurDir","blurDepthFalloff"],null,1,null,i.Constants.TEXTURE_NEAREST_SAMPLINGMODE,l,!1,null,t,void 0,void 0,void 0,h?i.Constants.TEXTUREFORMAT_RGBA:i.Constants.TEXTUREFORMAT_R);_.width=a,_.height=a,_.externalTextureSamplerBinding=!0,_.onApplyObservable.add((t=>{t.setTexture("textureSampler",e),t.setFloat("filterRadius",this.blurKernel>>1),t.setFloat2("blurDir",1/this._mapSize,0),t.setFloat("blurScale",.05),t.setFloat("blurDepthFalloff",.1)}));const c=new i.PostProcess("BilateralBlurY",n?"standardBlur":"bilateralBlur",["filterRadius","blurScale","blurDir","blurDepthFalloff"],null,1,null,i.Constants.TEXTURE_NEAREST_SAMPLINGMODE,l,!1,null,t,void 0,void 0,void 0,h?i.Constants.TEXTUREFORMAT_RGBA:i.Constants.TEXTUREFORMAT_R);return c.onApplyObservable.add((e=>{e.setFloat("filterRadius",this.blurKernel>>1),e.setFloat2("blurDir",0,1/this._mapSize),e.setFloat("blurScale",.05),e.setFloat("blurDepthFalloff",.1)})),_.autoClear=!1,c.autoClear=!1,[u,new i.ThinTexture(o),[_,c]]}_initializeLiquidRenderingStep(){const e=this._scene.getEngine(),t=Math.floor(this._mapSize/this.blurScale);this._renderPostProcess=new i.PostProcess("render","renderFluid",["projection","invProjection","invView","texelSize","dirLight","camPos"],["depthSampler","diffuseSampler","thicknessSampler","reflectionSampler"],1,this._scene.activeCamera,i.Constants.TEXTURE_NEAREST_SAMPLINGMODE,e,!1,null,i.Constants.TEXTURETYPE_UNSIGNED_BYTE),this._renderPostProcess.alphaMode=i.Constants.ALPHA_COMBINE,this._renderPostProcess.onApplyObservable.add((e=>{this._invProjectionMatrix.copyFrom(this._scene.getProjectionMatrix()),this._invProjectionMatrix.invert(),this._invViewMatrix.copyFrom(this._scene.getViewMatrix()),this._invViewMatrix.invert();let s=1/t;this._blurDepthPostProcesses&&0!==this._blurDepthPostProcesses.length?e.setTexture("depthSampler",this._textureBlurredDepth):(e.setTexture("depthSampler",this._textureDepth),s=1/this._mapSize),this.generateDiffuseTexture&&(this._blurDiffusePostProcesses&&0!==this._blurDiffusePostProcesses.length?e.setTexture("diffuseSampler",this._textureBlurredDiffuse):e.setTexture("diffuseSampler",this._textureDiffuse)),this._blurThicknessPostProcesses&&0!==this._blurThicknessPostProcesses.length?e.setTexture("thicknessSampler",this._textureBlurredThickness):e.setTexture("thicknessSampler",this._textureThickness),e.setMatrix("invProjection",this._invProjectionMatrix),e.setMatrix("projection",this._scene.getProjectionMatrix()),e.setMatrix("invView",this._invViewMatrix),e.setFloat("texelSize",s),e.setTexture("reflectionSampler",this._scene.environmentTexture),e.setVector3("dirLight",this.dirLight),e.setVector3("camPos",this._scene.activeCamera.globalPosition)})),this._renderPostProcess.onSizeChangedObservable.add((()=>{this._renderPostProcess.inputTexture.createDepthStencilTexture(0,!1,e.isStencilEnable,1),this._renderPostProcess.inputTexture._shareDepth(this._rtThickness)})),this._renderPostProcess.onActivateObservable.add((e=>{this._engine.clear(this._scene.clearColor,!0,!0,!0)})),this._passPostProcess=new i.PassPostProcess("pass",1,this._scene.activeCamera),this._passPostProcess.autoClear=!1,this._passPostProcess.shareOutputWith(this._renderPostProcess)}render(e){const t=this._depthEffectWrapper._drawWrapper,s=this._thicknessEffectWrapper._drawWrapper,r=t.effect,n=s.effect;if(!r.isReady()||!n.isReady()||!e.isReady())return;const h=this._engine._currentRenderTarget;this._engine.bindFramebuffer(this._rtDepth),this._engine.clear(this._depthClearColor,!0,!0,!1),this._engine.enableEffect(t),this._engine.bindBuffers(e.vertexBuffers,e.indexBuffer,r),r.setMatrix("view",this._scene.getViewMatrix()),r.setMatrix("projection",this._scene.getProjectionMatrix());const l=e.numParticles();e.useInstancing?this._engine.drawArraysType(i.Constants.MATERIAL_TriangleStripDrawMode,0,4,l):this._engine.drawElementsType(i.Constants.MATERIAL_TriangleFillMode,0,l),this._engine.unBindFramebuffer(this._rtDepth),this.generateDiffuseTexture&&e.generateDiffuseTexture&&(this._engine.bindFramebuffer(this._rtDiffuse),this._engine.clear(this._thicknessClearColor,!0,!0,!1),e.renderDiffuseTexture(),this._engine.unBindFramebuffer(this._rtDiffuse)),this._engine.bindFramebuffer(this._rtThickness),this._engine.clear(this._thicknessClearColor,!0,!1,!1),this._engine.setAlphaMode(i.Constants.ALPHA_ADD),this._engine.depthCullingState.depthMask=!1,this._engine.enableEffect(s),this._engine.bindBuffers(e.vertexBuffers,e.indexBuffer,n),n.setMatrix("view",this._scene.getViewMatrix()),n.setMatrix("projection",this._scene.getProjectionMatrix()),n.setFloat("particleAlpha",this.particleThicknessAlpha),e.useInstancing?this._engine.drawArraysType(i.Constants.MATERIAL_TriangleStripDrawMode,0,4,l):this._engine.drawElementsType(i.Constants.MATERIAL_TriangleFillMode,0,l),this._engine.depthCullingState.depthMask=!0,this._engine.setAlphaMode(i.Constants.ALPHA_DISABLE),this._engine.unBindFramebuffer(this._rtThickness),this._engine.unbindInstanceAttributes(),this._blurDepthPostProcesses&&this._blurDepthPostProcesses.length>0&&(this._scene.postProcessManager.directRender(this._blurDepthPostProcesses,this._rtDepthBlur,!0),this._engine.unBindFramebuffer(this._rtDepthBlur)),this.generateDiffuseTexture&&this._blurDiffusePostProcesses&&this._blurDiffusePostProcesses.length>0&&(this._scene.postProcessManager.directRender(this._blurDiffusePostProcesses,this._rtDiffuseBlur,!0),this._engine.unBindFramebuffer(this._rtDiffuseBlur)),this._blurThicknessPostProcesses&&this._blurThicknessPostProcesses.length>0&&(this._scene.postProcessManager.directRender(this._blurThicknessPostProcesses,this._rtThicknessBlur,!0),this._engine.unBindFramebuffer(this._rtThicknessBlur)),h&&this._engine.bindFramebuffer(h)}dispose(){var e,t,s,i,r,n,h,l,a,u;this.onDisposeObservable.hasObservers()&&this.onDisposeObservable.notifyObservers(this),null===(e=this._depthEffectWrapper)||void 0===e||e.dispose(),null===(t=this._rtDepth)||void 0===t||t.dispose(),null===(s=this._rtDepthBlur)||void 0===s||s.dispose(),this._rtDepthBlur=null,this._blurDepthPostProcesses&&this._blurDepthPostProcesses.forEach((e=>e.dispose())),this._blurDepthPostProcesses=[],null===(i=this._rtDiffuse)||void 0===i||i.dispose(),null===(r=this._rtDiffuseBlur)||void 0===r||r.dispose(),this._rtDiffuseBlur=null,this._blurDiffusePostProcesses&&this._blurDiffusePostProcesses.forEach((e=>e.dispose())),this._blurDiffusePostProcesses=[],null===(n=this._thicknessEffectWrapper)||void 0===n||n.dispose(),null===(h=this._rtThickness)||void 0===h||h.dispose(),null===(l=this._rtThicknessBlur)||void 0===l||l.dispose(),this._rtThicknessBlur=null,this._blurThicknessPostProcesses&&this._blurThicknessPostProcesses.forEach((e=>e.dispose())),this._blurThicknessPostProcesses=[],null===(a=this._renderPostProcess)||void 0===a||a.dispose(),null===(u=this._passPostProcess)||void 0===u||u.dispose()}}}}]);
//# sourceMappingURL=154.d8ae5f05c26f486a8932.js.map